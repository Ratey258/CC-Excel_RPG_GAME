<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Excel - å·¥ä½œç°¿1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #f3f2f1;
            overflow: hidden;
        }

        /* Excelæ ‡é¢˜æ  */
        .excel-titlebar {
            background: #2b579a;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .excel-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .excel-logo {
            width: 20px;
            height: 20px;
            background: #107c41;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .window-controls {
            display: flex;
            gap: 1px;
        }

        .control-btn {
            width: 45px;
            height: 29px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Excelèœå•æ  */
        .excel-menubar {
            background: #ffffff;
            border-bottom: 1px solid #d1d1d1;
            display: flex;
            align-items: center;
            height: 48px;
        }

        .menu-tabs {
            display: flex;
            margin-left: 15px;
        }

        .menu-tab {
            padding: 12px 20px;
            cursor: pointer;
            color: #323130;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }

        .menu-tab.active {
            border-bottom-color: #0078d4;
            color: #0078d4;
        }

        .menu-tab:hover {
            background: #f3f2f1;
        }

        /* Excelå·¥å…·æ  */
        .excel-toolbar {
            background: #ffffff;
            border-bottom: 1px solid #d1d1d1;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            height: 92px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 5px;
            padding-right: 15px;
            border-right: 1px solid #d1d1d1;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .toolbar-btn:hover {
            background: #f3f2f1;
        }

        /* å…¬å¼æ  */
        .formula-bar {
            background: #ffffff;
            border-bottom: 1px solid #d1d1d1;
            height: 25px;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }

        .name-box {
            width: 80px;
            height: 21px;
            border: 1px solid #a6a6a6;
            padding: 0 5px;
            font-size: 11px;
        }

        .formula-input {
            flex: 1;
            height: 21px;
            border: 1px solid #a6a6a6;
            margin-left: 5px;
            padding: 0 5px;
            font-size: 11px;
        }

        .save-status {
            height: 21px;
            padding: 0 8px;
            background: #f8f9fa;
            border: 1px solid #a6a6a6;
            border-left: none;
            font-size: 12px;
            cursor: pointer;
            min-width: 25px;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .save-status.saving {
            background: #fff3cd;
            color: #856404;
        }

        .save-status.saved {
            background: #d4edda;
            color: #155724;
        }

        /* Excelå·¥ä½œè¡¨åŒºåŸŸ */
        .excel-worksheet {
            background: #ffffff;
            height: calc(100vh - 225px);
            overflow: auto;
            position: relative;
        }

        /* è¡Œåˆ—æ ‡é¢˜ */
        .column-headers {
            position: sticky;
            top: 0;
            background: #f8f8f8;
            border-bottom: 1px solid #d4d4d4;
            display: flex;
            height: 20px;
            z-index: 10;
        }

        .corner-cell {
            width: 42px;
            min-width: 42px;
            background: #f8f8f8;
            border-right: 1px solid #d4d4d4;
            border-bottom: 1px solid #d4d4d4;
        }

        .column-header {
            width: 80px;
            min-width: 80px;
            text-align: center;
            font-size: 11px;
            color: #323130;
            line-height: 20px;
            border-right: 1px solid #d4d4d4;
            background: #f8f8f8;
            cursor: pointer;
        }

        /* å·¥ä½œè¡¨å†…å®¹ */
        .worksheet-content {
            display: flex;
            flex-direction: column;
        }

        .worksheet-row {
            display: flex;
            height: 20px;
        }

        .row-header {
            width: 42px;
            min-width: 42px;
            text-align: center;
            font-size: 11px;
            color: #323130;
            background: #f8f8f8;
            border-right: 1px solid #d4d4d4;
            border-bottom: 1px solid #e8e8e8;
            line-height: 20px;
            cursor: pointer;
        }

        .excel-cell {
            width: 80px;
            min-width: 80px;
            height: 20px;
            border-right: 1px solid #e8e8e8;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 6px;
            font-size: 11px;
            position: relative;
            cursor: cell;
        }

        .excel-cell:hover {
            background: #f3f2f1;
        }

        .excel-cell.selected {
            background: #0078d4;
            color: white;
        }

        .excel-cell.game-cell {
            background: #fff2cc;
            color: #9c5700;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }

        .excel-cell.monster-cell {
            background: #ffcccc;
            color: #c5504b;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }

        .excel-cell.treasure-cell {
            background: #e1dfdd;
            color: #7719aa;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }

        .excel-cell.boss-cell {
            background: #4c0000;
            color: #ff6666;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* çŠ¶æ€æ  */
        .excel-statusbar {
            background: #0078d4;
            color: white;
            height: 22px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            justify-content: space-between;
        }

        .status-left {
            display: flex;
            gap: 20px;
        }

        .status-right {
            display: flex;
            gap: 10px;
        }

        /* æ¸¸æˆé¢æ¿ */
        .game-panel {
            position: fixed;
            top: 50px;
            right: 20px;
            width: 250px;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 12px;
            z-index: 1000;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }

        .game-panel.show {
            display: block;
        }

        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #323130;
            border-bottom: 1px solid #e1dfdd;
            padding-bottom: 5px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1dfdd;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: #0078d4;
            transition: width 0.3s;
        }

        /* éšè—çš„æ¸¸æˆæ¶ˆæ¯ */
        .game-message {
            position: fixed;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: #323130;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .game-message.show {
            opacity: 1;
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .game-over-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .game-over-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            max-width: 400px;
        }

        .game-over-title {
            font-size: 24px;
            font-weight: bold;
            color: #c5504b;
            margin-bottom: 20px;
        }

        .game-over-stats {
            margin: 20px 0;
            text-align: left;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
            border-bottom: 1px solid #e1dfdd;
        }

        .restart-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }

        .restart-btn:hover {
            background: #106ebe;
        }

        /* è£…å¤‡ç³»ç»Ÿæ ·å¼ */
        .equipment-section {
            margin-top: 15px;
            border-top: 1px solid #e1dfdd;
            padding-top: 10px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 5px;
        }

        .equipment-slot {
            background: #f8f8f8;
            border: 1px solid #d1d1d1;
            border-radius: 3px;
            padding: 5px;
            text-align: center;
            font-size: 10px;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }

        .equipment-slot.equipped {
            background: #e6f3ff;
            border-color: #0078d4;
        }

        .equipment-slot .equipment-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .equipment-slot .equipment-power {
            color: #0078d4;
            font-size: 9px;
        }

        .equipment-inventory {
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }

        .inventory-item {
            background: #fff2cc;
            border: 1px solid #d4c5aa;
            border-radius: 3px;
            padding: 3px 5px;
            margin: 2px 0;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-item:hover {
            background: #ffe599;
        }

        .inventory-item.better {
            background: #d5e8d4;
            border-color: #70ad47;
        }

        .power-display {
            font-weight: bold;
            color: #c5504b;
        }

    </style>
</head>
<body>
    <!-- Excelæ ‡é¢˜æ  -->
    <div class="excel-titlebar">
        <div class="excel-title">
            <div class="excel-logo">X</div>
            <span>å·¥ä½œç°¿1 - Excel</span>
        </div>
        <div class="window-controls">
            <button class="control-btn">âˆ’</button>
            <button class="control-btn">â–¡</button>
            <button class="control-btn">Ã—</button>
        </div>
    </div>

    <!-- Excelèœå•æ  -->
    <div class="excel-menubar">
        <div class="menu-tabs">
            <div class="menu-tab">æ–‡ä»¶</div>
            <div class="menu-tab active">å¼€å§‹</div>
            <div class="menu-tab">æ’å…¥</div>
            <div class="menu-tab">é¡µé¢å¸ƒå±€</div>
            <div class="menu-tab">å…¬å¼</div>
            <div class="menu-tab">æ•°æ®</div>
            <div class="menu-tab">å®¡é˜…</div>
            <div class="menu-tab">è§†å›¾</div>
        </div>
    </div>

    <!-- Excelå·¥å…·æ  -->
    <div class="excel-toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" title="ç²˜è´´">ğŸ“‹</button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" title="å‰ªåˆ‡">âœ‚</button>
            <button class="toolbar-btn" title="å¤åˆ¶">ğŸ“„</button>
            <button class="toolbar-btn" title="æ ¼å¼åˆ·">ğŸ–Œ</button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" title="åŠ ç²—">B</button>
            <button class="toolbar-btn" title="æ–œä½“">I</button>
            <button class="toolbar-btn" title="ä¸‹åˆ’çº¿">U</button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" title="å‡½æ•°" onclick="toggleGamePanel()">fx</button>
            <button class="toolbar-btn" title="å›¾è¡¨" onclick="showGameStats()">ğŸ“Š</button>
            <button class="toolbar-btn" title="ä¿å­˜å·¥ä½œç°¿" onclick="manualSave()">ğŸ’¾</button>
        </div>
    </div>

    <!-- å…¬å¼æ  -->
    <div class="formula-bar">
        <input type="text" class="name-box" value="A1" readonly>
        <input type="text" class="formula-input" id="formulaInput" placeholder="ç‚¹å‡»å•å…ƒæ ¼å¼€å§‹æ¸¸æˆ..." readonly>
        <div class="save-status" id="saveStatus" title="å­˜æ¡£çŠ¶æ€">ğŸ’¾</div>
    </div>

    <!-- Excelå·¥ä½œè¡¨ -->
    <div class="excel-worksheet">
        <div class="column-headers">
            <div class="corner-cell"></div>
            <div class="column-header">A</div>
            <div class="column-header">B</div>
            <div class="column-header">C</div>
            <div class="column-header">D</div>
            <div class="column-header">E</div>
            <div class="column-header">F</div>
            <div class="column-header">G</div>
            <div class="column-header">H</div>
            <div class="column-header">I</div>
            <div class="column-header">J</div>
            <div class="column-header">K</div>
            <div class="column-header">L</div>
            <div class="column-header">M</div>
            <div class="column-header">N</div>
            <div class="column-header">O</div>
            <div class="column-header">P</div>
        </div>
        
        <div class="worksheet-content" id="worksheetContent">
            <!-- å·¥ä½œè¡¨è¡Œå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
        </div>
    </div>

    <!-- ExcelçŠ¶æ€æ  -->
    <div class="excel-statusbar">
        <div class="status-left">
            <span>å°±ç»ª</span>
            <span id="gameStatus">ç»éªŒå€¼: 0 | ç­‰çº§: 1</span>
        </div>
        <div class="status-right">
            <span>100%</span>
            <span>ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
        </div>
    </div>

    <!-- éšè—çš„æ¸¸æˆé¢æ¿ -->
    <div class="game-panel" id="gamePanel">
        <div class="panel-title">ğŸ“Š æ•°æ®é€è§†è¡¨</div>
        <div class="stat-row">
            <span>ç­‰çº§:</span>
            <span id="playerLevel">1</span>
        </div>
        <div class="stat-row">
            <span>ç»éªŒ:</span>
            <span id="playerExp">0/100</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="expBar" style="width: 0%"></div>
        </div>
        <div class="stat-row">
            <span>ç”Ÿå‘½å€¼:</span>
            <span id="playerHealth">100/100</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="healthBar" style="width: 100%; background: #ff4444;"></div>
        </div>
        <div class="stat-row">
            <span>é‡‘å¸:</span>
            <span id="playerGold">0</span>
        </div>
        <div class="stat-row">
            <span>æ€ªç‰©å‡»è´¥:</span>
            <span id="monstersKilled">0</span>
        </div>
        <div class="stat-row">
            <span>å®ç®±å¼€å¯:</span>
            <span id="treasuresFound">0</span>
        </div>
        <div class="stat-row">
            <span>æˆ˜åŠ›:</span>
            <span id="playerPower" class="power-display">100</span>
        </div>
        <div class="stat-row">
            <span>å½“å‰åˆ†æ•°:</span>
            <span id="currentScore">0</span>
        </div>
        
        <!-- è£…å¤‡ç³»ç»Ÿ -->
        <div class="equipment-section">
            <div class="panel-title">âš”ï¸ è£…å¤‡</div>
            <div class="equipment-grid">
                <div class="equipment-slot" id="weaponSlot" onclick="showEquipmentOptions('weapon')">
                    <div class="equipment-name">æ­¦å™¨</div>
                    <div class="equipment-power">+0</div>
                </div>
                <div class="equipment-slot" id="armorSlot" onclick="showEquipmentOptions('armor')">
                    <div class="equipment-name">æŠ¤ç”²</div>
                    <div class="equipment-power">+0</div>
                </div>
                <div class="equipment-slot" id="accessorySlot" onclick="showEquipmentOptions('accessory')">
                    <div class="equipment-name">é¥°å“</div>
                    <div class="equipment-power">+0</div>
                </div>
                <div class="equipment-slot" id="bootSlot" onclick="showEquipmentOptions('boot')">
                    <div class="equipment-name">é´å­</div>
                    <div class="equipment-power">+0</div>
                </div>
            </div>
            
            <div class="panel-title" style="margin-top: 10px;">ğŸ’ èƒŒåŒ…</div>
            <div class="equipment-inventory" id="equipmentInventory">
                <div style="text-align: center; color: #888; font-size: 10px;">æš‚æ— è£…å¤‡</div>
            </div>
        </div>
    </div>


    <!-- æ¸¸æˆæ¶ˆæ¯ -->
    <div class="game-message" id="gameMessage"></div>

    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <div class="game-over-panel" id="gameOverPanel">
        <div class="game-over-content">
            <div class="game-over-title">ğŸ’€ æ¸¸æˆç»“æŸ ğŸ’€</div>
            <p>ä½ è¢«å¼ºå¤§çš„Bosså‡»è´¥äº†ï¼</p>
            <div class="game-over-stats">
                <div class="stat-line">
                    <span>æœ€ç»ˆç­‰çº§:</span>
                    <span id="finalLevel">1</span>
                </div>
                <div class="stat-line">
                    <span>å‡»è´¥æ€ªç‰©:</span>
                    <span id="finalMonsters">0</span>
                </div>
                <div class="stat-line">
                    <span>å¼€å¯å®ç®±:</span>
                    <span id="finalTreasures">0</span>
                </div>
                <div class="stat-line">
                    <span>æ”¶é›†é‡‘å¸:</span>
                    <span id="finalGold">0</span>
                </div>
                <div class="stat-line">
                    <span><strong>æœ€ç»ˆåˆ†æ•°:</strong></span>
                    <span id="finalScore"><strong>0</strong></span>
                </div>
            </div>
            <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            level: 1,
            exp: 0,
            expNeeded: 100,
            gold: 0,
            health: 100,
            maxHealth: 100,
            power: 100, // åŸºç¡€æˆ˜åŠ›
            monstersKilled: 0,
            treasuresFound: 0,
            totalClicks: 0,
            errorCount: 0,
            score: 0,
            gameOver: false,
            equipment: {
                weapon: null,
                armor: null,
                accessory: null,
                boot: null
            },
            inventory: []
        };

        // æœ¬åœ°å­˜å‚¨é”®å
        const SAVE_KEY = 'excel_rpg_game_save';
        const WORKSHEET_KEY = 'excel_rpg_worksheet_save';

        // æ›´æ–°ä¿å­˜çŠ¶æ€æ˜¾ç¤º
        function updateSaveStatus(status) {
            const saveStatusEl = document.getElementById('saveStatus');
            if (!saveStatusEl) return;
            
            saveStatusEl.className = 'save-status';
            
            switch (status) {
                case 'saving':
                    saveStatusEl.className += ' saving';
                    saveStatusEl.textContent = 'â³';
                    saveStatusEl.title = 'æ­£åœ¨ä¿å­˜...';
                    break;
                case 'saved':
                    saveStatusEl.className += ' saved';
                    saveStatusEl.textContent = 'âœ…';
                    saveStatusEl.title = 'å·²ä¿å­˜';
                    setTimeout(() => {
                        saveStatusEl.className = 'save-status';
                        saveStatusEl.textContent = 'ğŸ’¾';
                        saveStatusEl.title = 'å­˜æ¡£çŠ¶æ€';
                    }, 2000);
                    break;
                case 'error':
                    saveStatusEl.textContent = 'âŒ';
                    saveStatusEl.title = 'ä¿å­˜å¤±è´¥';
                    setTimeout(() => {
                        saveStatusEl.textContent = 'ğŸ’¾';
                        saveStatusEl.title = 'å­˜æ¡£çŠ¶æ€';
                    }, 3000);
                    break;
                default:
                    saveStatusEl.textContent = 'ğŸ’¾';
                    saveStatusEl.title = 'å­˜æ¡£çŠ¶æ€';
            }
        }

        // ä¿å­˜æ¸¸æˆæ•°æ®
        function saveGame() {
            updateSaveStatus('saving');
            
            try {
                const saveData = {
                    gameState: gameState,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
                
                // ä¿å­˜å·¥ä½œè¡¨çŠ¶æ€
                const worksheetCells = [];
                document.querySelectorAll('.excel-cell').forEach(cell => {
                    const cellData = {
                        row: cell.getAttribute('data-row'),
                        col: cell.getAttribute('data-col'),
                        type: cell.getAttribute('data-type'),
                        power: cell.getAttribute('data-power'),
                        content: cell.textContent,
                        className: cell.className,
                        title: cell.title
                    };
                    if (cellData.type || cellData.content !== '') {
                        worksheetCells.push(cellData);
                    }
                });
                
                localStorage.setItem(WORKSHEET_KEY, JSON.stringify(worksheetCells));
                updateSaveStatus('saved');
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆå¤±è´¥:', error);
                updateSaveStatus('error');
                return false;
            }
        }

        // åŠ è½½æ¸¸æˆæ•°æ®
        function loadGame() {
            try {
                const saveData = localStorage.getItem(SAVE_KEY);
                if (!saveData) return false;
                
                const parsed = JSON.parse(saveData);
                if (parsed.gameState) {
                    // åˆå¹¶ä¿å­˜çš„çŠ¶æ€åˆ°å½“å‰çŠ¶æ€
                    gameState = { ...gameState, ...parsed.gameState };
                    
                    // ç¡®ä¿æ–°å­—æ®µå­˜åœ¨
                    if (!gameState.equipment) {
                        gameState.equipment = { weapon: null, armor: null, accessory: null, boot: null };
                    }
                    if (!gameState.inventory) {
                        gameState.inventory = [];
                    }
                    if (!gameState.power) {
                        gameState.power = 100;
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆå¤±è´¥:', error);
                return false;
            }
        }

        // åŠ è½½å·¥ä½œè¡¨æ•°æ®
        function loadWorksheet() {
            try {
                const worksheetData = localStorage.getItem(WORKSHEET_KEY);
                if (!worksheetData) return false;
                
                const cellsData = JSON.parse(worksheetData);
                
                // ç­‰å¾…å·¥ä½œè¡¨åˆ›å»ºå®Œæˆåå†åº”ç”¨æ•°æ®
                setTimeout(() => {
                    cellsData.forEach(cellData => {
                        const cell = document.querySelector(`[data-row="${cellData.row}"][data-col="${cellData.col}"]`);
                        if (cell) {
                            cell.className = cellData.className || 'excel-cell';
                            cell.textContent = cellData.content || '';
                            if (cellData.type) cell.setAttribute('data-type', cellData.type);
                            if (cellData.power) cell.setAttribute('data-power', cellData.power);
                            if (cellData.title) cell.title = cellData.title;
                        }
                    });
                }, 100);
                
                return true;
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œè¡¨å¤±è´¥:', error);
                return false;
            }
        }

        // æ¸…é™¤å­˜æ¡£
        function clearSave() {
            try {
                localStorage.removeItem(SAVE_KEY);
                localStorage.removeItem(WORKSHEET_KEY);
                showMessage('å­˜æ¡£å·²æ¸…é™¤');
                return true;
            } catch (error) {
                console.error('æ¸…é™¤å­˜æ¡£å¤±è´¥:', error);
                return false;
            }
        }

        // æ¸¸æˆæ•°æ®
        const gameData = {
            monsters: ['ğŸ‘¹', 'ğŸ‰', 'ğŸ‘¾', 'ğŸ¦–', 'ğŸ•·ï¸', 'ğŸº', 'ğŸ¦‡', 'ğŸ'],
            bosses: ['ğŸ’€', 'ğŸ”¥', 'âš¡', 'ğŸŒªï¸', 'â˜ ï¸', 'ğŸ‘‘', 'ğŸ—¡ï¸', 'âš”ï¸'],
            treasures: ['ğŸ’', 'ğŸ‘‘', 'ğŸ’°', 'ğŸ†', 'ğŸ’', 'ğŸ', 'âš±ï¸', 'ğŸ“¿'],
            heroes: ['ğŸ§™', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ¹', 'âš¡', 'ğŸ”¥', 'â„ï¸', 'âœ¨'],
            
            // è£…å¤‡æ•°æ®
            equipmentTypes: {
                weapon: {
                    name: 'æ­¦å™¨',
                    items: [
                        { name: 'é“å‰‘', power: 10, emoji: 'âš”ï¸', rarity: 'common' },
                        { name: 'é’¢å‰‘', power: 20, emoji: 'ğŸ—¡ï¸', rarity: 'uncommon' },
                        { name: 'é­”æ³•å‰‘', power: 35, emoji: 'âš¡', rarity: 'rare' },
                        { name: 'é¾™ç‰™å‰‘', power: 50, emoji: 'ğŸ²', rarity: 'epic' },
                        { name: 'ç¥åœ£ä¹‹å‰‘', power: 80, emoji: 'âœ¨', rarity: 'legendary' }
                    ]
                },
                armor: {
                    name: 'æŠ¤ç”²',
                    items: [
                        { name: 'å¸ƒç”²', power: 8, emoji: 'ğŸ‘•', rarity: 'common' },
                        { name: 'çš®ç”²', power: 15, emoji: 'ğŸ¦º', rarity: 'uncommon' },
                        { name: 'é”ç”²', power: 28, emoji: 'ğŸ›¡ï¸', rarity: 'rare' },
                        { name: 'æ¿ç”²', power: 45, emoji: 'âš™ï¸', rarity: 'epic' },
                        { name: 'é¾™é³ç”²', power: 70, emoji: 'ğŸ‰', rarity: 'legendary' }
                    ]
                },
                accessory: {
                    name: 'é¥°å“',
                    items: [
                        { name: 'é“œæˆ’æŒ‡', power: 5, emoji: 'ğŸ’', rarity: 'common' },
                        { name: 'é“¶é¡¹é“¾', power: 12, emoji: 'ğŸ“¿', rarity: 'uncommon' },
                        { name: 'é­”æ³•æŠ¤ç¬¦', power: 22, emoji: 'ğŸ”®', rarity: 'rare' },
                        { name: 'ç‹è€…ä¹‹å† ', power: 40, emoji: 'ğŸ‘‘', rarity: 'epic' },
                        { name: 'ç¥ä¹‹çœ¼', power: 65, emoji: 'ğŸ‘ï¸', rarity: 'legendary' }
                    ]
                },
                boot: {
                    name: 'é´å­',
                    items: [
                        { name: 'è‰é‹', power: 3, emoji: 'ğŸ‘Ÿ', rarity: 'common' },
                        { name: 'çš®é´', power: 8, emoji: 'ğŸ‘¢', rarity: 'uncommon' },
                        { name: 'ç–¾é£é´', power: 18, emoji: 'ğŸ‘ ', rarity: 'rare' },
                        { name: 'é£è¡Œé´', power: 30, emoji: 'ğŸ¦¶', rarity: 'epic' },
                        { name: 'ç¥é€Ÿä¹‹é´', power: 50, emoji: 'âš¡', rarity: 'legendary' }
                    ]
                }
            }
        };

        // åˆ›å»ºå·¥ä½œè¡¨
        function createWorksheet() {
            const worksheetContent = document.getElementById('worksheetContent');
            worksheetContent.innerHTML = '';

            for (let row = 1; row <= 50; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'worksheet-row';
                
                // è¡Œæ ‡é¢˜
                const rowHeader = document.createElement('div');
                rowHeader.className = 'row-header';
                rowHeader.textContent = row;
                rowDiv.appendChild(rowHeader);

                // å•å…ƒæ ¼
                for (let col = 0; col < 16; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'excel-cell';
                    cell.setAttribute('data-row', row);
                    cell.setAttribute('data-col', col);
                    
                    // éšæœºæ·»åŠ æ¸¸æˆå…ƒç´ 
                    if (Math.random() < 0.025) { // 2.5% æ¦‚ç‡
                        const type = Math.random();
                        if (type < 0.35) {
                            // æ™®é€šæ€ªç‰©
                            const monsterPower = Math.floor(Math.random() * 50) + gameState.level * 10 + 50;
                            cell.className += ' monster-cell';
                            cell.textContent = gameData.monsters[Math.floor(Math.random() * gameData.monsters.length)];
                            cell.setAttribute('data-type', 'monster');
                            cell.setAttribute('data-power', monsterPower);
                            cell.title = `æˆ˜åŠ›: ${monsterPower}`;
                        } else if (type < 0.4) {
                            // Bossæ€ªç‰© (å±é™©!)
                            const bossPower = Math.floor(Math.random() * 100) + gameState.level * 25 + 100;
                            cell.className += ' boss-cell';
                            cell.textContent = gameData.bosses[Math.floor(Math.random() * gameData.bosses.length)];
                            cell.setAttribute('data-type', 'boss');
                            cell.setAttribute('data-power', bossPower);
                            cell.title = `Bossæˆ˜åŠ›: ${bossPower}`;
                        } else if (type < 0.7) {
                            // å®ç®±
                            cell.className += ' treasure-cell';
                            cell.textContent = gameData.treasures[Math.floor(Math.random() * gameData.treasures.length)];
                            cell.setAttribute('data-type', 'treasure');
                        } else {
                            // è‹±é›„/æŠ€èƒ½
                            cell.className += ' game-cell';
                            cell.textContent = gameData.heroes[Math.floor(Math.random() * gameData.heroes.length)];
                            cell.setAttribute('data-type', 'hero');
                        }
                    } else {
                        // æ™®é€šæ•°æ®
                        const dataTypes = [
                            Math.floor(Math.random() * 1000),
                            (Math.random() * 100).toFixed(2),
                            '',
                            ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                            Math.floor(Math.random() * 10000),
                            ''
                        ];
                        cell.textContent = dataTypes[Math.floor(Math.random() * dataTypes.length)];
                    }
                    
                    cell.addEventListener('click', handleCellClick);
                    rowDiv.appendChild(cell);
                }
                
                worksheetContent.appendChild(rowDiv);
            }
        }

        // å¤„ç†å•å…ƒæ ¼ç‚¹å‡»
        function handleCellClick(event) {
            if (gameState.gameOver) return;
            
            const cell = event.target;
            const type = cell.getAttribute('data-type');
            const monsterPower = parseInt(cell.getAttribute('data-power')) || 0;
            const row = cell.getAttribute('data-row');
            const col = String.fromCharCode(65 + parseInt(cell.getAttribute('data-col')));
            
            // æ›´æ–°å…¬å¼æ 
            document.getElementById('formulaInput').value = `=${col}${row}`;
            document.querySelector('.name-box').value = `${col}${row}`;

            gameState.totalClicks++;
            
            if (type === 'monster') {
                // æ£€æŸ¥æˆ˜åŠ›æ˜¯å¦è¶³å¤Ÿ
                const playerPower = calculateTotalPower();
                if (playerPower < monsterPower) {
                    showMessage(`æˆ˜åŠ›ä¸è¶³! éœ€è¦${monsterPower}æˆ˜åŠ›ï¼Œå½“å‰${playerPower}æˆ˜åŠ›`);
                    return;
                }
                
                // å‡»è´¥æ™®é€šæ€ªç‰©
                const exp = Math.floor(Math.random() * 25) + 10;
                const gold = Math.floor(Math.random() * 15) + 5;
                const damage = Math.floor(Math.random() * 8) + 2; // 2-10 ä¼¤å®³
                
                gameState.health = Math.max(0, gameState.health - damage);
                addExp(exp);
                gameState.gold += gold;
                gameState.monstersKilled++;
                gameState.score += exp + gold;
                
                // æœ‰æ¦‚ç‡æ‰è½è£…å¤‡
                if (Math.random() < 0.3) { // 30% æ‰è½æ¦‚ç‡
                    const equipment = generateRandomEquipment();
                    addToInventory(equipment);
                    showMessage(`å‡»è´¥æ€ªç‰©! +${exp} ç»éªŒ, +${gold} é‡‘å¸, -${damage} ç”Ÿå‘½å€¼, è·å¾—è£…å¤‡: ${equipment.emoji}${equipment.name}`);
                } else {
                    showMessage(`å‡»è´¥æ€ªç‰©! +${exp} ç»éªŒ, +${gold} é‡‘å¸, -${damage} ç”Ÿå‘½å€¼`);
                }
                
                cell.textContent = 'ğŸ’€';
                cell.className = 'excel-cell';
                cell.removeAttribute('data-type');
                cell.removeAttribute('data-power');
                
                if (gameState.health <= 0) {
                    setTimeout(gameOver, 1500);
                }
                
            } else if (type === 'boss') {
                // æ£€æŸ¥æˆ˜åŠ›æ˜¯å¦è¶³å¤Ÿ
                const playerPower = calculateTotalPower();
                if (playerPower < monsterPower) {
                    showMessage(`Bossæˆ˜åŠ›è¿‡å¼º! éœ€è¦${monsterPower}æˆ˜åŠ›ï¼Œå½“å‰${playerPower}æˆ˜åŠ›`);
                    return;
                }
                
                // é­é‡Boss - é«˜é£é™©é«˜å›æŠ¥
                const success = Math.random() < (0.5 + gameState.level * 0.05); // åŸºç¡€50%æˆåŠŸç‡ + ç­‰çº§åŠ æˆ
                
                if (success) {
                    // æˆåŠŸå‡»è´¥Boss
                    const exp = Math.floor(Math.random() * 80) + 50;
                    const gold = Math.floor(Math.random() * 60) + 40;
                    const damage = Math.floor(Math.random() * 15) + 10; // 10-25 ä¼¤å®³
                    
                    gameState.health = Math.max(0, gameState.health - damage);
                    addExp(exp);
                    gameState.gold += gold;
                    gameState.monstersKilled++;
                    gameState.score += (exp + gold) * 2; // BossåŒå€åˆ†æ•°
                    
                    // Bosså¿…å®šæ‰è½é«˜çº§è£…å¤‡
                    const equipment = generateRandomEquipment(true);
                    addToInventory(equipment);
                    
                    cell.textContent = 'ğŸ‘‘';
                    cell.className = 'excel-cell';
                    cell.removeAttribute('data-type');
                    cell.removeAttribute('data-power');
                    
                    if (gameState.health <= 0) {
                        showMessage(`å‡»è´¥Bossä½†åŠ›ç«­è€Œäº¡! æ¸¸æˆç»“æŸ!`);
                        setTimeout(gameOver, 1500);
                    } else {
                        showMessage(`ğŸ‰ å‡»è´¥Boss! +${exp} ç»éªŒ, +${gold} é‡‘å¸, -${damage} ç”Ÿå‘½å€¼, è·å¾—è£…å¤‡: ${equipment.emoji}${equipment.name}`);
                    }
                } else {
                    // è¢«Bosså‡»è´¥
                    showMessage(`ğŸ’€ è¢«å¼ºå¤§çš„Bosså‡»è´¥! æ¸¸æˆç»“æŸ!`);
                    setTimeout(gameOver, 1500);
                    return;
                }
                
            } else if (type === 'treasure') {
                // å¼€å¯å®ç®±
                const exp = Math.floor(Math.random() * 40) + 20;
                const gold = Math.floor(Math.random() * 30) + 15;
                const healing = Math.floor(Math.random() * 15) + 10; // 10-25 æ²»ç–—
                
                addExp(exp);
                gameState.gold += gold;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healing);
                gameState.treasuresFound++;
                gameState.score += exp + gold + healing;
                
                // å®ç®±æœ‰æ›´é«˜æ¦‚ç‡æ‰è½è£…å¤‡
                if (Math.random() < 0.6) { // 60% æ‰è½æ¦‚ç‡
                    const equipment = generateRandomEquipment();
                    addToInventory(equipment);
                    showMessage(`å‘ç°å®ç®±! +${exp} ç»éªŒ, +${gold} é‡‘å¸, +${healing} ç”Ÿå‘½å€¼, è·å¾—è£…å¤‡: ${equipment.emoji}${equipment.name}`);
                } else {
                    showMessage(`å‘ç°å®ç®±! +${exp} ç»éªŒ, +${gold} é‡‘å¸, +${healing} ç”Ÿå‘½å€¼`);
                }
                
                cell.textContent = 'ğŸ“¦';
                cell.className = 'excel-cell';
                cell.removeAttribute('data-type');
                
            } else if (type === 'hero') {
                // è·å¾—æŠ€èƒ½/buff
                const exp = Math.floor(Math.random() * 15) + 5;
                const healing = Math.floor(Math.random() * 10) + 5; // 5-15 æ²»ç–—
                
                addExp(exp);
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healing);
                gameState.score += exp + healing;
                
                cell.textContent = 'â­';
                cell.className = 'excel-cell';
                cell.removeAttribute('data-type');
                
                showMessage(`è·å¾—æŠ€èƒ½å¼ºåŒ–! +${exp} ç»éªŒ, +${healing} ç”Ÿå‘½å€¼`);
                
            } else {
                // æ™®é€šå•å…ƒæ ¼ - å°é‡ç»éªŒ
                if (Math.random() < 0.1) { // 10% æ¦‚ç‡è·å¾—ç»éªŒ
                    const exp = Math.floor(Math.random() * 3) + 1;
                    addExp(exp);
                    gameState.score += exp;
                    showMessage(`æ•°æ®åˆ†æå®Œæˆ +${exp} ç»éªŒ`);
                }
            }
            
            updateDisplay();
            
            // è‡ªåŠ¨ä¿å­˜æ¸¸æˆ
            saveGame();
        }

        // è®¡ç®—æ€»æˆ˜åŠ›
        function calculateTotalPower() {
            let totalPower = gameState.power + (gameState.level - 1) * 20; // åŸºç¡€æˆ˜åŠ› + ç­‰çº§åŠ æˆ
            
            // è£…å¤‡åŠ æˆ
            Object.values(gameState.equipment).forEach(equipment => {
                if (equipment) {
                    totalPower += equipment.power;
                }
            });
            
            return totalPower;
        }

        // ç”Ÿæˆéšæœºè£…å¤‡
        function generateRandomEquipment(isBoss = false) {
            const types = Object.keys(gameData.equipmentTypes);
            const randomType = types[Math.floor(Math.random() * types.length)];
            const equipmentList = gameData.equipmentTypes[randomType].items;
            
            let equipment;
            if (isBoss) {
                // Bossæ‰è½é«˜çº§è£…å¤‡
                const highLevelEquipment = equipmentList.filter(item => 
                    item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary'
                );
                equipment = highLevelEquipment[Math.floor(Math.random() * highLevelEquipment.length)];
            } else {
                // æ™®é€šæ‰è½ï¼Œæ ¹æ®ç­‰çº§è°ƒæ•´æ‰è½æ¦‚ç‡
                const rarityWeights = {
                    common: Math.max(60 - gameState.level * 5, 10),
                    uncommon: Math.min(25 + gameState.level * 2, 40),
                    rare: Math.min(10 + gameState.level * 2, 30),
                    epic: Math.min(4 + gameState.level, 15),
                    legendary: Math.min(1 + Math.floor(gameState.level / 5), 5)
                };
                
                const totalWeight = Object.values(rarityWeights).reduce((sum, weight) => sum + weight, 0);
                let random = Math.random() * totalWeight;
                
                for (const [rarity, weight] of Object.entries(rarityWeights)) {
                    random -= weight;
                    if (random <= 0) {
                        const rarityEquipment = equipmentList.filter(item => item.rarity === rarity);
                        equipment = rarityEquipment[Math.floor(Math.random() * rarityEquipment.length)];
                        break;
                    }
                }
            }
            
            return {
                ...equipment,
                type: randomType,
                id: Date.now() + Math.random()
            };
        }

        // æ·»åŠ åˆ°èƒŒåŒ…
        function addToInventory(equipment) {
            gameState.inventory.push(equipment);
            updateInventoryDisplay();
        }

        // è£…å¤‡ç‰©å“
        function equipItem(equipment) {
            // å¸ä¸‹å½“å‰è£…å¤‡
            if (gameState.equipment[equipment.type]) {
                gameState.inventory.push(gameState.equipment[equipment.type]);
            }
            
            // è£…å¤‡æ–°ç‰©å“
            gameState.equipment[equipment.type] = equipment;
            
            // ä»èƒŒåŒ…ç§»é™¤
            const index = gameState.inventory.findIndex(item => item.id === equipment.id);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
            }
            
            updateEquipmentDisplay();
            updateInventoryDisplay();
            updateDisplay();
            
            showMessage(`è£…å¤‡äº† ${equipment.emoji}${equipment.name} (+${equipment.power} æˆ˜åŠ›)`);
            
            // è‡ªåŠ¨ä¿å­˜æ¸¸æˆ
            saveGame();
        }

        // æ›´æ–°è£…å¤‡æ˜¾ç¤º
        function updateEquipmentDisplay() {
            Object.keys(gameState.equipment).forEach(type => {
                const slot = document.getElementById(type + 'Slot');
                const equipment = gameState.equipment[type];
                
                if (equipment) {
                    slot.className = 'equipment-slot equipped';
                    slot.innerHTML = `
                        <div class="equipment-name">${equipment.emoji}${equipment.name}</div>
                        <div class="equipment-power">+${equipment.power}</div>
                    `;
                } else {
                    slot.className = 'equipment-slot';
                    slot.innerHTML = `
                        <div class="equipment-name">${gameData.equipmentTypes[type].name}</div>
                        <div class="equipment-power">+0</div>
                    `;
                }
            });
        }

        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
        function updateInventoryDisplay() {
            const inventoryEl = document.getElementById('equipmentInventory');
            
            if (gameState.inventory.length === 0) {
                inventoryEl.innerHTML = '<div style="text-align: center; color: #888; font-size: 10px;">æš‚æ— è£…å¤‡</div>';
                return;
            }
            
            inventoryEl.innerHTML = gameState.inventory.map(equipment => {
                const currentEquipment = gameState.equipment[equipment.type];
                const isBetter = !currentEquipment || equipment.power > currentEquipment.power;
                
                return `
                    <div class="inventory-item ${isBetter ? 'better' : ''}" onclick="equipItem(${JSON.stringify(equipment).replace(/"/g, '&quot;')})">
                        <span>${equipment.emoji}${equipment.name}</span>
                        <span>+${equipment.power}</span>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºè£…å¤‡é€‰é¡¹ï¼ˆæš‚æ—¶ä¿ç•™æ¥å£ï¼‰
        function showEquipmentOptions(type) {
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°æ›´å¤æ‚çš„è£…å¤‡ç®¡ç†ç•Œé¢
            showMessage(`ç‚¹å‡»èƒŒåŒ…ä¸­çš„è£…å¤‡æ¥æ›¿æ¢${gameData.equipmentTypes[type].name}`);
        }

        // æ‰‹åŠ¨ä¿å­˜æ¸¸æˆ
        function manualSave() {
            const success = saveGame();
            if (success) {
                showMessage('ğŸ’¾ å·¥ä½œç°¿å·²ä¿å­˜');
            } else {
                showMessage('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¢åŠ ç»éªŒå€¼
        function addExp(amount) {
            gameState.exp += amount;
            
            // æ£€æŸ¥å‡çº§
            while (gameState.exp >= gameState.expNeeded) {
                gameState.exp -= gameState.expNeeded;
                gameState.level++;
                gameState.expNeeded = Math.floor(gameState.expNeeded * 1.5);
                
                // å‡çº§æ—¶å¢åŠ æœ€å¤§ç”Ÿå‘½å€¼å’ŒåŸºç¡€æˆ˜åŠ›
                gameState.maxHealth += 10;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 20); // å‡çº§å›è¡€
                gameState.power += 5; // å‡çº§å¢åŠ åŸºç¡€æˆ˜åŠ›
                
                showMessage(`ğŸ‰ ç­‰çº§æå‡! ç°åœ¨æ˜¯ ${gameState.level} çº§! ç”Ÿå‘½å€¼å’Œæˆ˜åŠ›å¢åŠ !`);
                
                // å‡çº§æ—¶åˆ·æ–°åœ°å›¾
                setTimeout(() => {
                    refreshGameElements();
                    saveGame(); // å‡çº§åä¿å­˜
                }, 1000);
            }
        }

        // åˆ·æ–°æ¸¸æˆå…ƒç´ 
        function refreshGameElements() {
            const cells = document.querySelectorAll('.excel-cell');
            let addedElements = 0;
            
            cells.forEach(cell => {
                if (!cell.getAttribute('data-type') && addedElements < 15) {
                    if (Math.random() < 0.05) { // 5% æ¦‚ç‡æ·»åŠ æ–°å…ƒç´ 
                        const type = Math.random();
                        if (type < 0.35) {
                            const monsterPower = Math.floor(Math.random() * 50) + gameState.level * 10 + 50;
                            cell.className = 'excel-cell monster-cell';
                            cell.textContent = gameData.monsters[Math.floor(Math.random() * gameData.monsters.length)];
                            cell.setAttribute('data-type', 'monster');
                            cell.setAttribute('data-power', monsterPower);
                            cell.title = `æˆ˜åŠ›: ${monsterPower}`;
                        } else if (type < 0.4 + (gameState.level * 0.01)) { // Bossæ¦‚ç‡éšç­‰çº§å¢åŠ 
                            const bossPower = Math.floor(Math.random() * 100) + gameState.level * 25 + 100;
                            cell.className = 'excel-cell boss-cell';
                            cell.textContent = gameData.bosses[Math.floor(Math.random() * gameData.bosses.length)];
                            cell.setAttribute('data-type', 'boss');
                            cell.setAttribute('data-power', bossPower);
                            cell.title = `Bossæˆ˜åŠ›: ${bossPower}`;
                        } else if (type < 0.7) {
                            cell.className = 'excel-cell treasure-cell';
                            cell.textContent = gameData.treasures[Math.floor(Math.random() * gameData.treasures.length)];
                            cell.setAttribute('data-type', 'treasure');
                        } else {
                            cell.className = 'excel-cell game-cell';
                            cell.textContent = gameData.heroes[Math.floor(Math.random() * gameData.heroes.length)];
                            cell.setAttribute('data-type', 'hero');
                        }
                        addedElements++;
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            const messageEl = document.getElementById('gameMessage');
            messageEl.textContent = message;
            messageEl.classList.add('show');
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 2000);
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // è®¡ç®—å½“å‰æ€»æˆ˜åŠ›
            const totalPower = calculateTotalPower();
            
            // æ›´æ–°çŠ¶æ€æ 
            document.getElementById('gameStatus').textContent = 
                `ç”Ÿå‘½å€¼: ${gameState.health}/${gameState.maxHealth} | æˆ˜åŠ›: ${totalPower} | ç»éªŒå€¼: ${gameState.exp}/${gameState.expNeeded} | ç­‰çº§: ${gameState.level}`;
            
            // æ›´æ–°æ¸¸æˆé¢æ¿
            document.getElementById('playerLevel').textContent = gameState.level;
            document.getElementById('playerExp').textContent = `${gameState.exp}/${gameState.expNeeded}`;
            document.getElementById('playerHealth').textContent = `${gameState.health}/${gameState.maxHealth}`;
            document.getElementById('playerPower').textContent = totalPower;
            document.getElementById('playerGold').textContent = gameState.gold;
            document.getElementById('monstersKilled').textContent = gameState.monstersKilled;
            document.getElementById('treasuresFound').textContent = gameState.treasuresFound;
            document.getElementById('currentScore').textContent = gameState.score;
            
            const expPercent = (gameState.exp / gameState.expNeeded) * 100;
            document.getElementById('expBar').style.width = `${expPercent}%`;
            
            const healthPercent = (gameState.health / gameState.maxHealth) * 100;
            document.getElementById('healthBar').style.width = `${healthPercent}%`;
            
            // æ ¹æ®ç”Ÿå‘½å€¼æ”¹å˜é¢œè‰²
            const healthBar = document.getElementById('healthBar');
            if (healthPercent > 60) {
                healthBar.style.background = '#4CAF50'; // ç»¿è‰²
            } else if (healthPercent > 30) {
                healthBar.style.background = '#FF9800'; // æ©™è‰²
            } else {
                healthBar.style.background = '#F44336'; // çº¢è‰²
            }
        }

        // åˆ‡æ¢æ¸¸æˆé¢æ¿
        function toggleGamePanel() {
            const panel = document.getElementById('gamePanel');
            panel.classList.toggle('show');
        }

        // æ˜¾ç¤ºæ¸¸æˆç»Ÿè®¡
        function showGameStats() {
            const panel = document.getElementById('gamePanel');
            panel.classList.add('show');
            showMessage('æ•°æ®é€è§†è¡¨å·²æ›´æ–°');
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameState.gameOver = true;
            
            // æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('finalMonsters').textContent = gameState.monstersKilled;
            document.getElementById('finalTreasures').textContent = gameState.treasuresFound;
            document.getElementById('finalGold').textContent = gameState.gold;
            document.getElementById('finalScore').textContent = gameState.score;
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
            document.getElementById('gameOverPanel').style.display = 'flex';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            // æ¸…é™¤å­˜æ¡£
            clearSave();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = {
                level: 1,
                exp: 0,
                expNeeded: 100,
                gold: 0,
                health: 100,
                maxHealth: 100,
                power: 100, // åŸºç¡€æˆ˜åŠ›
                monstersKilled: 0,
                treasuresFound: 0,
                totalClicks: 0,
                errorCount: 0,
                score: 0,
                gameOver: false,
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null,
                    boot: null
                },
                inventory: []
            };
            
            // éšè—æ¸¸æˆç»“æŸç•Œé¢
            document.getElementById('gameOverPanel').style.display = 'none';
            
            // é‡æ–°åˆ›å»ºå·¥ä½œè¡¨
            createWorksheet();
            updateDisplay();
            updateEquipmentDisplay();
            updateInventoryDisplay();
            
            // é‡ç½®å…¬å¼æ 
            document.getElementById('formulaInput').value = '';
            document.querySelector('.name-box').value = 'A1';
            
            showMessage('æ–°æ¸¸æˆå¼€å§‹! ç¥ä½ å¥½è¿!');
            
            // ä¿å­˜æ–°æ¸¸æˆçŠ¶æ€
            saveGame();
        }

        // è‡ªåŠ¨åˆ·æ–°æ¸¸æˆå…ƒç´ 
        setInterval(() => {
            if (!gameState.gameOver && Math.random() < 0.3) { // 30% æ¦‚ç‡åˆ·æ–°
                refreshGameElements();
                saveGame(); // åˆ·æ–°åä¿å­˜
            }
        }, 30000); // æ¯30ç§’

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // å°è¯•åŠ è½½å­˜æ¡£
            const hasLoadedGame = loadGame();
            
            if (hasLoadedGame) {
                showMessage('å·²åŠ è½½å­˜æ¡£æ•°æ®');
                // å…ˆåˆ›å»ºå·¥ä½œè¡¨
                createWorksheet();
                // ç„¶ååŠ è½½å·¥ä½œè¡¨æ•°æ®
                loadWorksheet();
            } else {
                showMessage('å¼€å§‹æ–°æ¸¸æˆ');
                createWorksheet();
            }
            
            updateDisplay();
            updateEquipmentDisplay();
            updateInventoryDisplay();
        }

        // åˆå§‹åŒ–
        initializeGame();
        
        // è‡ªåŠ¨ä¿å­˜æ¸¸æˆçŠ¶æ€ï¼ˆä¼ªè£…æˆExcelè‡ªåŠ¨ä¿å­˜ï¼‰
        setInterval(() => {
            if (!gameState.gameOver && Math.random() < 0.1) {
                saveGame();
                showMessage('å·¥ä½œç°¿å·²è‡ªåŠ¨ä¿å­˜');
            }
        }, 45000); // æ¯45ç§’

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', function(e) {
            saveGame();
        });
    </script>
</body>
</html>
